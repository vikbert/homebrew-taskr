version: '3'
project: Homebrew
banner: true

vars:
  FORMULA_FILE: Formula/taskr.rb
  REPO_URL: https://github.com/vikbert/taskr

tasks:
  default:
    desc: æ˜¾ç¤ºæ‰€æœ‰å¯ç”¨ä»»åŠ¡
    cmds:
      - taskr --list

  update:
    desc: æ›´æ–°å…¬å¼åˆ°æ–°ç‰ˆæœ¬
    summary: |
      æ›´æ–° Homebrew å…¬å¼åˆ°æŒ‡å®šç‰ˆæœ¬
      ç”¨æ³•: task update <ç‰ˆæœ¬å·>
      ä¾‹å¦‚: task update 3.47.7
    cmds:
      - |
        if [ -z "{{.CLI_ARGS}}" ]; then
          echo "âŒ é”™è¯¯: è¯·æä¾›ç‰ˆæœ¬å·"
          echo "ç”¨æ³•: task update <ç‰ˆæœ¬å·>"
          echo "ä¾‹å¦‚: task update 3.47.7"
          exit 1
        fi
        ./update_formula.sh {{.CLI_ARGS}}

  verify:
    desc: éªŒè¯å…¬å¼æ–‡ä»¶çš„æ›´æ”¹
    summary: æ˜¾ç¤º Formula/taskr.rb çš„ git diff å’Œå½“å‰å†…å®¹
    cmds:
      - |
        echo "ğŸ“‹ æ˜¾ç¤ºæ›´æ”¹å·®å¼‚ï¼š"
        echo "=========================================="
        git diff {{.FORMULA_FILE}} || echo "æ²¡æœ‰æœªæš‚å­˜çš„æ›´æ”¹"
        echo ""
        echo "ğŸ“ å½“å‰å…¬å¼æ–‡ä»¶å†…å®¹ï¼š"
        echo "=========================================="
        cat {{.FORMULA_FILE}}

  commit:
    desc: æäº¤å…¬å¼æ›´æ”¹åˆ° Git
    summary: |
      æ·»åŠ ã€æäº¤å¹¶æ¨é€å…¬å¼æ›´æ”¹
      ç”¨æ³•: task commit [--no-push] è·³è¿‡æ¨é€æ­¥éª¤
    cmds:
      - |
        if ! git diff --quiet {{.FORMULA_FILE}} && ! git diff --cached --quiet {{.FORMULA_FILE}}; then
          echo "ğŸ“¦ æ·»åŠ æ–‡ä»¶åˆ°æš‚å­˜åŒº..."
          git add {{.FORMULA_FILE}}

          # ä»å…¬å¼æ–‡ä»¶ä¸­æå–ç‰ˆæœ¬å·
          VERSION=$(grep 'url.*tags/v' {{.FORMULA_FILE}} | sed -E 's/.*tags\/v([0-9]+\.[0-9]+\.[0-9]+).*/\1/' | head -1)
          if [ -z "$VERSION" ]; then
            VERSION="unknown"
          fi

          echo "ğŸ’¾ æäº¤æ›´æ”¹..."
          git commit -m "Update TaskR to v${VERSION}"

          # æ£€æŸ¥æ˜¯å¦éœ€è¦æ¨é€
          if [[ "{{.CLI_ARGS}}" != *"--no-push"* ]]; then
            echo "ğŸš€ æ¨é€åˆ°è¿œç¨‹ä»“åº“..."
            git push origin main
            echo "âœ… å·²æˆåŠŸæ¨é€æ›´æ”¹"
          else
            echo "â„¹ï¸  è·³è¿‡æ¨é€ï¼ˆä½¿ç”¨ --no-push æ ‡å¿—ï¼‰"
            echo "æ‰‹åŠ¨æ¨é€: git push origin main"
          fi
        else
          echo "â„¹ï¸  æ²¡æœ‰éœ€è¦æäº¤çš„æ›´æ”¹"
        fi

  test:
    desc: æµ‹è¯•æ–°ç‰ˆæœ¬çš„å®‰è£…
    summary: æ›´æ–° Homebrewï¼Œé‡æ–°å®‰è£… taskr å¹¶æ£€æŸ¥ç‰ˆæœ¬
    cmds:
      - |
        echo "ğŸ”„ æ›´æ–° Homebrew..."
        brew update

        echo "ğŸ“¦ é‡æ–°å®‰è£… taskr..."
        brew reinstall taskr

        echo "âœ… æ£€æŸ¥å®‰è£…çš„ç‰ˆæœ¬ï¼š"
        taskr --version

  version:
    desc: æ˜¾ç¤ºå½“å‰å…¬å¼çš„ç‰ˆæœ¬ä¿¡æ¯
    summary: ä» Formula/taskr.rb æå–å¹¶æ˜¾ç¤ºç‰ˆæœ¬å·
    cmds:
      - |
        echo "ğŸ“‹ å½“å‰å…¬å¼ç‰ˆæœ¬ä¿¡æ¯ï¼š"
        echo "=========================================="
        VERSION=$(grep 'url.*tags/v' {{.FORMULA_FILE}} | sed -E 's/.*tags\/v([0-9]+\.[0-9]+\.[0-9]+).*/\1/' | head -1)
        SHA256=$(grep 'sha256' {{.FORMULA_FILE}} | sed -E 's/.*sha256 "([^"]+)".*/\1/' | head -1)
        URL=$(grep 'url' {{.FORMULA_FILE}} | grep -v 'head' | sed -E 's/.*url "([^"]+)".*/\1/' | head -1)

        echo "ç‰ˆæœ¬å·: v${VERSION}"
        echo "SHA256: $SHA256"
        echo "URL:    $URL"
        echo ""
        echo "å…¬å¼æ–‡ä»¶: {{.FORMULA_FILE}}"

  status:
    desc: æ£€æŸ¥ Git ä»“åº“çŠ¶æ€
    summary: æ˜¾ç¤ºä»“åº“çŠ¶æ€å’Œæœªæäº¤çš„æ›´æ”¹
    cmds:
      - |
        echo "ğŸ“Š Git ä»“åº“çŠ¶æ€ï¼š"
        echo "=========================================="
        git status
        echo ""
        echo "ğŸ“ å…¬å¼æ–‡ä»¶çŠ¶æ€ï¼š"
        echo "=========================================="
        if git diff --quiet {{.FORMULA_FILE}} 2>/dev/null; then
          if git diff --cached --quiet {{.FORMULA_FILE}} 2>/dev/null; then
            echo "âœ… {{.FORMULA_FILE}} æ²¡æœ‰æœªæäº¤çš„æ›´æ”¹"
          else
            echo "ğŸ“¦ {{.FORMULA_FILE}} å·²æš‚å­˜ï¼Œç­‰å¾…æäº¤"
            git diff --cached {{.FORMULA_FILE}}
          fi
        else
          echo "ğŸ“ {{.FORMULA_FILE}} æœ‰æœªæš‚å­˜çš„æ›´æ”¹ï¼š"
          git diff {{.FORMULA_FILE}}
        fi

  release:
    desc: å®Œæ•´å‘å¸ƒæµç¨‹ï¼ˆæ›´æ–°ã€éªŒè¯ã€æäº¤ã€æµ‹è¯•ï¼‰
    summary: |
      æ‰§è¡Œå®Œæ•´çš„å‘å¸ƒæµç¨‹ï¼š
      1. æ›´æ–°å…¬å¼åˆ°æ–°ç‰ˆæœ¬
      2. éªŒè¯æ›´æ”¹
      3. æäº¤å¹¶æ¨é€
      4. æµ‹è¯•å®‰è£…
      ç”¨æ³•: task release <ç‰ˆæœ¬å·>
      ä¾‹å¦‚: task release 3.47.7
    cmds:
      - |
        if [ -z "{{.CLI_ARGS}}" ]; then
          echo "âŒ é”™è¯¯: è¯·æä¾›ç‰ˆæœ¬å·"
          echo "ç”¨æ³•: task release <ç‰ˆæœ¬å·>"
          echo "ä¾‹å¦‚: task release 3.47.7"
          exit 1
        fi

        echo "ğŸš€ å¼€å§‹å‘å¸ƒæµç¨‹..."
        echo ""

        echo "æ­¥éª¤ 1/4: æ›´æ–°å…¬å¼..."
        task update {{.CLI_ARGS}}
        echo ""

        echo "æ­¥éª¤ 2/4: éªŒè¯æ›´æ”¹..."
        task verify
        echo ""

        read -p "æ˜¯å¦ç»§ç»­æäº¤æ›´æ”¹? (y/n) " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
          echo "æ­¥éª¤ 3/4: æäº¤æ›´æ”¹..."
          task commit
          echo ""

          echo "æ­¥éª¤ 4/4: æµ‹è¯•å®‰è£…..."
          task test
          echo ""

          echo "âœ… å‘å¸ƒæµç¨‹å®Œæˆï¼"
        else
          echo "â„¹ï¸  å·²å–æ¶ˆæäº¤ï¼Œä½ å¯ä»¥ç¨åæ‰‹åŠ¨è¿è¡Œ:"
          echo "  task commit"
          echo "  task test"
        fi

